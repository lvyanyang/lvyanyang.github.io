(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{411:function(s,t,a){"use strict";a.r(t);var e=a(25),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"机构数据权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#机构数据权限"}},[s._v("#")]),s._v(" 机构数据权限")]),s._v(" "),a("p",[s._v("在项目开发过程中经常有这样一种需求，需要根据不同的人显示不同机构的数据。本质上就是根据配置，在后台生成不同的过滤SQL实现结构数据权限。")]),s._v(" "),a("p",[s._v("目前支持的数据权限分为以下几种：")]),s._v(" "),a("ol",[a("li",[s._v("全部")]),s._v(" "),a("li",[s._v("自定义")]),s._v(" "),a("li",[s._v("所在机构及所有下级")]),s._v(" "),a("li",[s._v("所在机构")]),s._v(" "),a("li",[s._v("仅本人")])]),s._v(" "),a("p",[s._v("由于每个角色都可以设置机构数据权限，当一个用户拥有多个角色时，多个角色中的机构数据权限会进行合并，合并策略在系统参数"),a("code",[s._v("sys.dept.scopeMergeStrategy")]),s._v("进行配置。")]),s._v(" "),a("p",[s._v("机构数据权限合并策略：")]),s._v(" "),a("ol",[a("li",[s._v("有更大的权限时优先采用更大的权限")]),s._v(" "),a("li",[s._v("有更小的权限时优先采用更小的权限")])]),s._v(" "),a("h2",{attrs:{id:"使用方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[s._v("#")]),s._v(" 使用方法")]),s._v(" "),a("ol",[a("li",[s._v("在需要使用机构数据权限的服务方法设置"),a("code",[s._v("@DeptScope")]),s._v("注解。")])]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@DeptScope")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SysRole")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SysRoleFilter")]),s._v(" filter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("方法参数中，必须要有一个实现了"),a("code",[s._v("IDeptScope")]),s._v("接口的参数")])]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SysRoleFilter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BasePageFilter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IDeptScope")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("在MybatisXML中的SQL中，添加与机构表的关联。")])]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[s._v("select r.id,r.name,d.id dept_id,d.name dept_name\nfrom sys_role r left join sys_dept d on r.dept_id = d.id\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("在SQL中的where标签添加权限过滤语句"),a("code",[s._v('<include refid="com.github.lvyanyang.sys.dao.SysDao.deptScope"/>')])])]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("where")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("test")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("filter.status != null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("r.status = #{filter.status}"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("refid")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.github.lvyanyang.sys.dao.SysDao.deptScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("where")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" 注意事项")]),s._v(" "),a("ol",[a("li",[s._v("用启用机构数据权限，必须要使用"),a("code",[s._v("@Authorize")]),s._v("标注到控制器中，客户端Header中必须要传递token值，否则无法获取用户信息。")]),s._v(" "),a("li",[a("code",[s._v("@DeptScope")]),s._v("注解可以设置属性"),a("code",[s._v("deptIdName")]),s._v("，表示关联机构表主键名称。默认值:d.id,"),a("code",[s._v("d")]),s._v("表示机构表别名。")]),s._v(" "),a("li",[s._v("方法参数中设置"),a("code",[s._v("enableDeptScope")]),s._v("来控制是否启用机构数据权限过滤。")]),s._v(" "),a("li",[s._v("超管用户直接返回所有数据。")]),s._v(" "),a("li",[s._v("如果账号停用，或者所属机构无效，则会抛出异常。")])])])}),[],!1,null,null,null);t.default=n.exports}}]);